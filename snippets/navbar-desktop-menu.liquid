{%- assign selected_blocks_megamenu = section.blocks | where: 'type', 'megamenu' -%}
{%- for block in selected_blocks_megamenu -%}
    {% capture items_with_megamenu %}{{ block.settings.for_item | handle }}||{{ items_with_megamenu }}{% endcapture %}
{%- endfor -%}
{%- assign items_with_megamenu = items_with_megamenu | split: '||' -%}

<ul class="nav me-auto">
  {% for link in linklists[section.settings.main_menu].links %}

    <li class="nav-item {% if link.links %}dropdown{% endif %}">
      
      {% # SINGLE ITEM MENU LEVEL %}
      {% if link.links == blank %}
        <a
          class="nav-link {% if link.active %}active{% endif %}" 
          href="{{ link.url }}"
          aria-current="{% if link.active %}page{% endif %}">
          {{ link.title }}
        </a>
      {% else %}

        <a 
          class="nav-link dropdown-toggle {% if link.child_active %}active{% endif %}" 
          href="#"
          data-bs-toggle="dropdown" 
          data-bs-display="static"
          aria-expanded="false"
          role="button">
          {{ link.title }}
        </a>
        <ul class="dropdown-menu">

        {% if items_with_megamenu contains link.handle %}
          <li>
{{ section | json }}
            {% render 'megamenu' with link as megalink %}
          </li>
        {% else %}
          
          {% for child_link in link.links %}
            <li>
              {% if child_link.title == '-' %}
                <hr class="dropdown-divider">
              {% else %}
                <a 
                  class="dropdown-item {% if child_link.active %}active{% endif %}" 
                  href="{{ child_link.url }}"
                  aria-current="{% if child_link.active %}page{% endif %}">
                  {{ child_link.title }}
                </a>
              {% endif %}
            </li>
          {% endfor %}
          {% endif %}
        </ul>

      {% endif %}
    </li>
  {% endfor %}
</ul>